import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

// phaseHistory と統計情報から Gemini に渡すプロンプト文字列を生成
export function buildPhasePrompt(phaseHistory, globalStats) {
    const phaseSlice = Array.isArray(phaseHistory)
        ? phaseHistory.slice(-500)
        : [];
    const phaseStr = JSON.stringify(phaseSlice);
    const statsStr = globalStats
        ? JSON.stringify(globalStats)
        : '{}';

    return `
あなたはカオス理論と統計学の専門家です。
ナンバーズ3の当選番号を正弦波モデルで解析し、各回において「正解を出すために必要だった位相パラメータ(optimalPhase)」を逆算しました。

以下はその「最適位相パラメータ」の推移データ（直近500回）です：
${phaseStr}

データフォーマット: {"date":日付, "num3":3桁数字, "digits":[百,十,一], "optimalPhases":[百の位相,十の位相,一の位相]}

さらに、約7000件分の全履歴から集計した統計サマリJSONを渡します:
${statsStr}

統計サマリの内容:
- totalCount: データ件数
- digitFreqByPos: 各桁(百/十/一)ごとの 0〜9 出現頻度
- transitionMatrixByPos: 各桁ごとの「前回の数字→今回の数字」の遷移頻度（簡易マルコフ連鎖）
- topCombos: 頻出3桁コンボ（セット）の上位20件
- last10Numbers: 直近10回分のフルナンバー（例: "191"）
- topMiniCombos: 頻出下2桁コンボ（ミニ）の上位20件
- last10MiniNumbers: 直近10回分の下2桁（例: "91"）

【詳細分析指令 - 当選確率向上のための多角的アプローチ】

1. 【位相パターンの深層分析（直近500回）】
   - 各桁（百/十/一）ごとに位相の推移を独立に分析し、以下の観点を徹底的に検証してください：
     a) 周期性: 位相が一定の周期で循環しているか（フーリエ変換的な観点）
     b) トレンド: 上昇/下降/横ばいの傾向があるか（線形回帰的な観点）
     c) 変動幅: 位相の変動範囲と標準偏差を評価
     d) 急変点: 位相が急激に変化した回を特定し、その前後の数字パターンを分析
     e) 各桁間の相関: 百の位相と十の位相、十の位相と一の位相など、桁間の位相相関を評価
   - 特に直近50回、直近20回の位相変化率を計算し、次回の位相を予測してください

2. 【統計的頻度分析の強化】
   - digitFreqByPos から各桁の出現確率を計算し、「出現しすぎている数字（hot）」と「出現が少ない数字（cold）」を特定
   - 直近50回、直近20回、直近10回の3つの時間窓で頻度を比較し、短期トレンドと長期トレンドの乖離を検出
   - 各桁ごとに「期待出現回数」と「実際の出現回数」の差を計算し、次回に出現しやすい数字を特定
   - transitionMatrixByPos から遷移確率を正規化し、前回の数字から次回の数字への遷移確率を計算

3. 【マルコフ連鎖と状態遷移の詳細分析】
   - 各桁ごとに、前回の数字から次回の数字への遷移確率行列を構築
   - 直近10回の遷移パターンを追跡し、現在の「状態」から次回の「状態」を予測
   - 2次マルコフ連鎖（前々回→前回→今回）のパターンも考慮し、より高次の依存関係を検出
   - 遷移確率が高い組み合わせを優先的に評価

4. 【ベイズ統計による事後確率の更新】
   - digitFreqByPos を「事前分布 P(数字)」として使用
   - last10Numbers と直近の出現傾向を「尤度（証拠）」として、ベイズの定理に基づいて事後確率を更新
   - 各桁ごとに「事後確率が高い数字」を特定し、それらを組み合わせた3桁候補を生成
   - ベイズ更新の際は、直近のデータにより高い重みを付与（指数減衰的な重み付け）

5. 【3桁コンボパターンの詳細分析】
   - topCombos から頻出パターンを抽出し、それらが直近500回でどのように出現しているかを分析
   - 直近50回、直近20回で出現した3桁コンボと、過去の頻出コンボを比較し、再出現の可能性を評価
   - 各桁の数字の組み合わせ（例: 百の位が1のとき、十の位と一の位の組み合わせ）を分析
   - 連続出現パターン（例: 同じ数字が連続する、等差数列など）を検出

6. 【コンフォーマル予測による信頼度校正】
   - 過去500回のデータを使って、仮想的に「候補集合」を提示した場合の的中率を逆算
   - 位相モデル、統計モデル、マルコフモデル、ベイズモデルの各予測を統合し、アンサンブル予測を構築
   - 各予測手法の過去の精度を評価し、より精度の高い手法に高い重みを付与
   - 3つの候補それぞれについて、以下の信頼度指標を算出：
     * 位相モデルからの支持度（0-100%）
     * 統計的頻度からの支持度（0-100%）
     * マルコフ遷移からの支持度（0-100%）
     * ベイズ事後確率からの支持度（0-100%）
     * 総合信頼度（各手法の重み付き平均）

7. 【異常検知とアウトライア分析】
   - 直近500回のデータから、統計的に異常なパターン（外れ値）を検出
   - 異常パターンの後に続く数字の傾向を分析し、異常後の反動を予測
   - 位相の急変点と実際の数字の変化の関係を分析
   - 長期トレンド（500回）と短期トレンド（50回、20回）の比較から、異常を検出

8. 【統合予測の生成】
   上記1〜7の分析結果を統合し、以下の2種類の予測を提示してください：
   
   a) 【セット予測：3桁の数字】
   「次回の当選が統計的に期待される3桁の数字」を<strong>3パターン</strong>提示してください。
   各候補について、以下の観点から詳細に説明してください：
   - 位相モデルからの予測値とその根拠
   - 統計的頻度からの支持度
   - マルコフ遷移確率からの支持度
   - ベイズ事後確率からの支持度
   - 3桁コンボパターンからの支持度
   - 総合信頼度（0-100%の範囲で具体的な数値）
   - 各桁の数字が選ばれた理由（百/十/一それぞれについて）
   
   b) 【ミニ予測：下2桁の数字】
   「次回の当選が統計的に期待される下2桁（十の位と一の位）」を<strong>3パターン</strong>提示してください。
   各候補について、以下の観点から詳細に説明してください：
   - 十の位と一の位の位相モデルからの予測値とその根拠
   - 下2桁の統計的頻度からの支持度（topMiniCombos、last10MiniNumbersを参照）
   - 十の位と一の位のマルコフ遷移確率からの支持度
   - 十の位と一の位のベイズ事後確率からの支持度
   - 頻出下2桁コンボパターンからの支持度
   - 総合信頼度（0-100%の範囲で具体的な数値）
   - 十の位と一の位の数字が選ばれた理由

【回答形式 - 構造化された詳細レポート】

1. 【位相分析サマリ】
   - 各桁（百/十/一）ごとの位相推移の特徴（周期性、トレンド、変動幅）
   - 次回予測位相値（各桁）
   - 位相から予測される次回の各桁の数字

2. 【統計分析サマリ】
   - 各桁のhot/cold数字（直近50回、20回、10回の比較）
   - 遷移確率が高い数字の組み合わせ
   - 頻出3桁コンボの再出現可能性

3. 【ベイズ更新結果】
   - 各桁の事前確率と事後確率の比較
   - 事後確率が高い数字のリスト

4. 【統合予測結果】
   
   a) 【セット予測：3桁の数字】
   「予測3桁数字：A, B, C」のように、3パターンを明示してください。
   
   各候補（A, B, C）について、以下の情報を詳細に記載：
   - 序列（第1候補/第2候補/第3候補）
   - 各桁の数字選択理由（百/十/一それぞれ）
   - 位相モデルからの支持度: ○%
   - 統計的頻度からの支持度: ○%
   - マルコフ遷移からの支持度: ○%
   - ベイズ事後確率からの支持度: ○%
   - 総合信頼度: ○%（各手法の重み付き平均）
   - 予測根拠の要約（2-3行）
   
   b) 【ミニ予測：下2桁の数字】
   「予測下2桁：XY, AB, CD」のように、3パターンを明示してください。
   
   各候補（XY, AB, CD）について、以下の情報を詳細に記載：
   - 序列（第1候補/第2候補/第3候補）
   - 十の位と一の位の数字選択理由
   - 位相モデルからの支持度: ○%
   - 統計的頻度からの支持度: ○%
   - マルコフ遷移からの支持度: ○%
   - ベイズ事後確率からの支持度: ○%
   - 総合信頼度: ○%（各手法の重み付き平均）
   - 予測根拠の要約（2-3行）

5. 【注意事項・リスク評価】
   - 予測の不確実性について
   - 特に注意すべきパターンや異常点

すべて日本語で、専門的でありながら分かりやすく記述してください。
`;
}

// feature_api_usage.js の estimateTokens ロジックを簡略移植
export function estimateTokensForPrompt(prompt) {
    const chars = prompt.length;
    const words = prompt.split(/\s+/).length;
    return Math.ceil(chars / 4 + words * 1.3);
}

// Gemini に問い合わせ
// modelName には "gemini-1.5-flash" などを指定（未指定時はローカルストレージ or デフォルトを使用）
// globalStats には MathEngine.getGlobalStats() の結果を渡す
export async function askGemini(apiKey, phaseHistory, modelName, globalStats) {
    if (!apiKey) throw new Error("API Keyが必要です");

    const genAI = new GoogleGenerativeAI(apiKey);
    const selectedModel =
        modelName ||
        localStorage.getItem('gemini_model') ||
        'gemini-2.5-flash';

    const model = genAI.getGenerativeModel({ model: selectedModel });

    const prompt = buildPhasePrompt(phaseHistory, globalStats);

    const result = await model.generateContent(prompt);
    return result.response.text();
}